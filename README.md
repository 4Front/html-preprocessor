# htmlprep

[![NPM Version][npm-image]][npm-url]
[![NPM Downloads][downloads-image]][downloads-url]
[![Build Status][travis-image]][travis-url]
[![Test Coverage][coveralls-image]][coveralls-url]

High-performance HTML pre-processor designed to be run in middleware, but also suitable for packaging up in a build task. Utilizes a streaming API based on [htmlparser2](https://www.npmjs.com/package/htmlparser2). Useful when you need to apply basic markup modifications to HTML files at run-time and as a zero-config alternative to gulp and grunt plugins for optimizing release versions of HTML pages.

Makes use of [standard-compliant](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Using_data_attributes) `data-*` attributes to annotate the markup indicating where custom processing should occur. These attributes are stripped out of the final output, so the HTML sent down to the browser leaves no traces behind. 

Intended as a light-weight HTML decorator rather than a full-blown template engine such as [Jade](http://www.jade-lang.com). However it's certainly possible for HTML generated by Jade, or another template language, to be piped through htmlprep.

## Example
Use in express route or middleware:

```js
var htmlprep = require('htmlprep');

res.set('Content-Type', 'text/html');
fs.createReadStream('./views/index.html')
  .pipe(htmlprep({
    cdnify: true,
    cdnHost: 'cdnhost.com/dir'
  }))
  .pipe(res);
```

## Features
### Repoint assets to CDN
Rewrite relative asset paths to point to an absolute CDN url. If the `cdnHost` option is set to "cdnhost.com/dir" then:

```html
<script src="/js/app.js"></script>
<img src="/images/logo.gif">
```
becomes:

```html
<script src="//cdnhost.com/dir/js/app.js"></script>
<img src="//cdnhost.com/dir/images/logo.gif">
```

### Build-specific blocks
Omit HTML blocks or individual tags based on a custom build attribute. Useful for declaring which scripts or stylesheets should be present in release vs. debug mode. 

```html
<link rel="stylesheet" href="/css/layout.css" data-build="debug">
<link rel="stylesheet" href="/css/nav.css" data-build="debug">
<link rel="stylesheet" href="/dist/app.min.css" data-build="release">
<div data-build="debug">
    <script src="/js/app.js"></script>
    <script src="/js/models.js"></script>
    <script src="/js/controllers.js"></script>
</div>
<script src="dist/app.min.js" data-build="release">
```

When called with `buildType:"debug"` becomes:

```html
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/nav.css">
<div>
    <script src="/js/app.js"></script>
    <script src="/js/models.js"></script>
    <script src="/js/controllers.js"></script>
</div>
```

And with `buildType:"release"`:

```html
<link rel="stylesheet" href="/dist/app.min.css">
<script src="dist/app.min.js">
```

### Block injection
Inject blocks of HTML at render time to the `<head>` or `<body>` tags or to a named block specified with the `data-placeholder` attribute. 

```js
htmlprep({
 inject: {
  head: '<style>body {background-color:blue}</style>'
  body: '<!-- End of body -->',
  'before-nav': 'before nav',
  'after-nav': 'after nav'
 }
});
```
```html
<html>
 <head>
 </head>
 <body>
  <div data-placeholder="before-nav"></div>
  <nav></nav>
  <div data-placeholder="after-nav"></div>
 </body>
</html>
```
becomes:

```html
<html>
 <head>
   <style>body { background-color:blue; }</style>
 </head>
 <body>
  <div>before nav</div>
  <nav></nav>
  <div>after nav</div>
  <!-- End of body -->
 </body>
</html>
```

### LiveReload
Appends the livereload script at the end of the body.

```js
<script src="//localhost:35729/livereload.js"></script>
```

## Options
All the possible attributes that can be specifed in the `options` parameter.

* __`buildType`__ - All elements with 
* __`livereload`__ - Specify if the localhost LiveReload script should be injected.
* __`livereloadPort`__ - The port number for livereload.js, defaults to 35729.
* __`cdnify`__ - Specify that relative asset URLs be repointed to an absolute CDN path.
* __`cdnHost`__ - The CDN host to point to if `cdnify` is true. 
* __`inject`__ - Object of HTML blocks to inject over placeholders. The keys `body` and `head` will append to those respective tag names rather than a corresponding placeholder.
* __`attrPrefix`__ - Specify a custom prefix for data attributes. So instead of `data-build`, you could use `data-myprefix-build`.

## Roadmap
### User-Agent specific blocks
Exclude blocks of HTML where the request user-agent does not pass an expression test. Useful for including polyfill scripts conditionally or excluding content from mobile devices to lighten the HTML payload.

```html
<div data-useragent="IE<=8">
</div>
<script src="js/mobile-optimized.js" data-useragent="phone"></script>
```

[npm-image]: https://img.shields.io/npm/v/htmlprep.svg?style=flat
[npm-url]: https://npmjs.org/package/htmlprep
[travis-image]: https://img.shields.io/travis/4front/htmlprep.svg?style=flat
[travis-url]: https://travis-ci.org/4front/htmlprep
[coveralls-image]: https://img.shields.io/coveralls/4front/htmlprep.svg?style=flat
[coveralls-url]: https://coveralls.io/r/4front/htmlprep?branch=master
[downloads-image]: https://img.shields.io/npm/dm/htmlprep.svg?style=flat
[downloads-url]: https://npmjs.org/package/htmlprep
