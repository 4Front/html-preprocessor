# htmlprep

[![NPM Version][npm-image]][npm-url]
[![NPM Downloads][downloads-image]][downloads-url]
[![Build Status][travis-image]][travis-url]
[![Test Coverage][coveralls-image]][coveralls-url]

High-performance HTML pre-processor designed to be run in middleware, but also suitable for packaging up in a build task. Utilizes a streaming API based on [htmlparser2](https://www.npmjs.com/package/htmlparser2). Useful when you need to apply basic markup modifications to HTML files at run-time and as a zero-config alternative to gulp and grunt plugins for optimizing release versions of HTML pages.

Makes use of [standard-compliant](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Using_data_attributes) `data-*` attributes to annotate the markup indicating where custom processing should occur. These attributes are stripped out of the final output, so the HTML sent down to the browser leaves no traces behind.

Intended as a light-weight HTML decorator rather than a full-blown template engine such as [Jade](http://www.jade-lang.com). However it's certainly possible for HTML generated by Jade, or another template language, to be piped through htmlprep.

## Example
Use in express route or middleware:

~~~js
var htmlprep = require('htmlprep');

res.set('Content-Type', 'text/html');
fs.createReadStream('./views/index.html')
  .pipe(htmlprep({
    assetPathPrefix: '//cdnhost.com/dir'
  }))
  .pipe(res);
~~~

## Features
### Prepend prefix to asset URLs
Prepend a string to all `src` and link `href` attributes. Canonical use case is repointing assets to a CDN. If the `assetPathPrefix` option is set to "//cdnhost.com/assets" then:

~~~html
<script src="/js/app.js"></script>
<img src="/images/logo.gif">
~~~
becomes:

~~~html
<script src="//cdnhost.com/assets/js/app.js"></script>
<img src="//cdnhost.com/assets/images/logo.gif">
~~~

You can prevent this behavior for specific assets by providing a list of glob patterns to the `noPathPrefixPatterns` option. The value of the each asset path, i.e. `/images/logo.gif` is evaluated against each pattern using [minimatch](https://www.npmjs.com/package/minimatch).

For example if you wanted all `.jpg` files in the images directory to be left alone, you'd do this:

~~~js
htmlprep({
  assetPathPrefix: '//cdhhost.com/assets',
  noPathPrefixPatterns: ['/images/*.jpg']
});
~~~

### Build-specific blocks
Omit HTML blocks or individual tags based on a custom build attribute. Useful for declaring which scripts or stylesheets should be present in release vs. debug mode.

~~~html
<link rel="stylesheet" href="/css/layout.css" data-build="debug">
<link rel="stylesheet" href="/css/nav.css" data-build="debug">
<link rel="stylesheet" href="/dist/app.min.css" data-build="release">
<div data-build="debug">
    <script src="/js/app.js"></script>
    <script src="/js/models.js"></script>
    <script src="/js/controllers.js"></script>
</div>
<script src="dist/app.min.js" data-build="release">
~~~

When called with `buildType:"debug"` becomes:

~~~html
<link rel="stylesheet" href="/css/layout.css">
<link rel="stylesheet" href="/css/nav.css">
<div>
    <script src="/js/app.js"></script>
    <script src="/js/models.js"></script>
    <script src="/js/controllers.js"></script>
</div>
~~~

And with `buildType:"release"`:

~~~html
<link rel="stylesheet" href="/dist/app.min.css">
<script src="dist/app.min.js">
~~~

### Block injection
Inject blocks of HTML at render time to the `<head>` or `<body>` tags or to a named block specified with the `data-placeholder` attribute.

~~~js
htmlprep({
 inject: {
  head: '<style>body {background-color:blue}</style>'
  body: '<!-- End of body -->',
  'before-nav': 'before nav',
  'after-nav': 'after nav'
 }
});
~~~
~~~html
<html>
	<head>  
	</head>
 	<body>
	  	<div data-placeholder="before-nav"></div>
	  	<nav></nav>
		<div data-placeholder="after-nav"></div>
	</body>
</html>
~~~
becomes:

~~~html
<html>
	<head>
   		<style>body { background-color:blue; }</style>
	</head>
	<body>
  		<div>before nav</div>
	  	<nav></nav>
	  	<div>after nav</div>
	  	<!-- End of body -->
	</body>
</html>
~~~

### JavaScript and stylesheet expansion
Declare a single `script` or `link` with a glob pattern and automatically expand to individual elements for every matching file. File matches are relative to the directory specified in the `cwd` option.

~~~html
<html>
	<head>
		<link rel="stylesheet" data-expand-href="css/**/*.css"/>
	</head>
	<body>
    	<script data-src-expand="js/**/*.js"></script>
	</body>
</html>
~~~

becomes:

~~~html
<html>
	<head>
		<link rel="stylesheet" href="main.css"/>
		<link rel="stylesheet" href="layout.css"/>
	</head>
	<body>
    	<script src="js/app.js"></script>
    	<script src="js/blog.js"></script>
    	<script src="js/nav.js"></script>
  </body>
</html>
~~~


### LiveReload
Appends the livereload script at the end of the body.

~~~js
<script src="//localhost:35729/livereload.js"></script>
~~~

## Options
All the possible attributes that can be specifed in the `options` parameter.

* __`buildType`__ - Remove all elements that have a `data-build` attribute whose value does not match the specified value.
* __`liveReload`__ - Specify if the localhost LiveReload script should be injected.
* __`liveReloadPort`__ - The port number for livereload.js, defaults to 35729.
* __`assetPathPrefix`__ - The string to prepend to all relative asset URLs. Works with `script`, `link`, `img`, and `embed` tags.
* __`inject`__ - Object of HTML blocks to inject over placeholders. The keys `body` and `head` will append to those respective tag names rather than a corresponding placeholder.
* __`attrPrefix`__ - Specify a custom prefix for data attributes. So instead of `data-build`, you could use `data-myprefix-build`.
* __`cwd`__ - The current working directory. Defaults to `process.cwd`.

## Roadmap
### User-Agent specific blocks
Exclude blocks of HTML where the request user-agent does not pass an expression test. Useful for including polyfill scripts conditionally or excluding content from mobile devices to lighten the HTML payload.

## License
Licensed under the [Apache License, Version 2.0](http://www.apache.org/licenses/LICENSE-2.0).

[npm-image]: https://img.shields.io/npm/v/htmlprep.svg?style=flat
[npm-url]: https://npmjs.org/package/htmlprep
[travis-image]: https://img.shields.io/travis/4front/htmlprep.svg?style=flat
[travis-url]: https://travis-ci.org/4front/htmlprep
[coveralls-image]: https://img.shields.io/coveralls/4front/htmlprep.svg?style=flat
[coveralls-url]: https://coveralls.io/r/4front/htmlprep?branch=master
[downloads-image]: https://img.shields.io/npm/dm/htmlprep.svg?style=flat
[downloads-url]: https://npmjs.org/package/htmlprep
